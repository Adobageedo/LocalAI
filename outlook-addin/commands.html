<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Email Template Generator Commands</title>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>

    <script type="text/javascript">
        Office.onReady(function() {
            // Office is ready
        });

        // API Configuration
        const API_BASE_URL = 'https://chardouin.fr/api';

        // Helper function to get email content
        function getEmailContent(callback) {
            Office.context.mailbox.item.body.getAsync(
                Office.CoercionType.Text,
                function(result) {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        callback({
                            subject: Office.context.mailbox.item.subject,
                            body: result.value,
                            from: Office.context.mailbox.item.sender ? Office.context.mailbox.item.sender.emailAddress : '',
                            to: Office.context.mailbox.item.to ? Office.context.mailbox.item.to.map(t => t.emailAddress).join(', ') : ''
                        });
                    } else {
                        console.error('Failed to get email content:', result.error);
                        callback(null);
                    }
                }
            );
        }

        // Helper function to call API
        async function callAPI(endpoint, data) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Summarize Email Function
        function summarizeEmail(event) {
            getEmailContent(async function(emailData) {
                if (!emailData) {
                    event.completed();
                    return;
                }

                try {
                    const response = await callAPI('/outlook/prompt', {
                        userId: 'outlook-user',
                        subject: emailData.subject,
                        body: emailData.body,
                        from: emailData.from,
                        tone: 'professional',
                        language: 'french',
                        additionalInfo: 'Veuillez fournir un r√©sum√© concis de cet email en fran√ßais.'
                    });

                    // Show summary in a dialog
                    Office.context.ui.displayDialogAsync(
                        `data:text/html,<html><head><title>R√©sum√©</title><style>body{font-family:Segoe UI,Arial,sans-serif;padding:20px;line-height:1.6;}</style></head><body><h2>üìù R√©sum√© de l'email</h2><div style="background:#f5f5f5;padding:15px;border-radius:5px;margin:10px 0;"><strong>Sujet:</strong> ${emailData.subject}</div><div style="background:#e8f4fd;padding:15px;border-radius:5px;">${response.generated_text}</div></body></html>`,
                        {height: 60, width: 50},
                        function(result) {
                            if (result.status === Office.AsyncResultStatus.Failed) {
                                console.error('Dialog failed to open:', result.error.message);
                            }
                        }
                    );
                } catch (error) {
                    console.error('Summarize failed:', error);
                }
                
                event.completed();
            });
        }

        // Suggest Reply Function
        function suggestReply(event) {
            getEmailContent(async function(emailData) {
                if (!emailData) {
                    event.completed();
                    return;
                }

                try {
                    const response = await callAPI('/outlook/prompt', {
                        userId: 'outlook-user',
                        subject: emailData.subject,
                        body: emailData.body,
                        from: emailData.from,
                        tone: 'professional',
                        language: 'french',
                        additionalInfo: 'Veuillez sugg√©rer une r√©ponse appropri√©e √† cet email en fran√ßais.'
                    });

                    // Create a new compose item with the suggested reply
                    Office.context.mailbox.displayNewMessageForm({
                        toRecipients: [emailData.from],
                        subject: emailData.subject.startsWith('Re:') ? emailData.subject : 'Re: ' + emailData.subject,
                        htmlBody: `<div style="font-family: Segoe UI, Arial, sans-serif;">${response.generated_text}</div>`
                    });
                } catch (error) {
                    console.error('Suggest reply failed:', error);
                }
                
                event.completed();
            });
        }

        // Reformulate Email Function
        function reformulateEmail(event) {
            getEmailContent(async function(emailData) {
                if (!emailData) {
                    event.completed();
                    return;
                }

                try {
                    const response = await callAPI('/outlook/prompt', {
                        userId: 'outlook-user',
                        subject: emailData.subject,
                        body: emailData.body,
                        tone: 'professional',
                        language: 'french',
                        additionalInfo: 'Veuillez reformuler ce texte pour am√©liorer la clart√©, le style et la fluidit√© tout en conservant le sens original.'
                    });

                    // Replace the current email body with the reformulated version
                    Office.context.mailbox.item.body.setAsync(
                        response.generated_text,
                        {coercionType: Office.CoercionType.Html},
                        function(result) {
                            if (result.status === Office.AsyncResultStatus.Failed) {
                                console.error('Failed to update email body:', result.error);
                            }
                        }
                    );
                } catch (error) {
                    console.error('Reformulate failed:', error);
                }
                
                event.completed();
            });
        }

        // Correct Email Function
        function correctEmail(event) {
            getEmailContent(async function(emailData) {
                if (!emailData) {
                    event.completed();
                    return;
                }

                try {
                    const response = await callAPI('/outlook/prompt', {
                        userId: 'outlook-user',
                        subject: emailData.subject,
                        body: emailData.body,
                        tone: 'professional',
                        language: 'french',
                        additionalInfo: 'Veuillez corriger toutes les erreurs de grammaire, d\'orthographe, de ponctuation et de syntaxe dans ce texte tout en pr√©servant le sens et le style original.'
                    });

                    // Replace the current email body with the corrected version
                    Office.context.mailbox.item.body.setAsync(
                        response.generated_text,
                        {coercionType: Office.CoercionType.Html},
                        function(result) {
                            if (result.status === Office.AsyncResultStatus.Failed) {
                                console.error('Failed to update email body:', result.error);
                            }
                        }
                    );
                } catch (error) {
                    console.error('Correct failed:', error);
                }
                
                event.completed();
            });
        }

        // Legacy function for backward compatibility
        function action(event) {
            Office.context.ui.displayDialogAsync(
                'https://chardouin.fr/taskpane.html?action=generate',
                {height: 50, width: 30},
                function (result) {
                    if (result.status === Office.AsyncResultStatus.Failed) {
                        console.error('Dialog failed to open: ' + result.error.message);
                    }
                }
            );
            
            event.completed();
        }
    </script>
</head>
<body>
    <!-- Note: This file is only used to implement functions for UI-less buttons. -->
</body>
</html>
